# AGENTS.md

This file provides guidance to AI coding agents when working with code in this repository.

> **Important**: When making changes to the codebase that affect architecture, APIs, commands, configuration options, or any documented behavior, update this file accordingly to keep it in sync with the actual implementation.

## Build Commands

```bash
# Check Rust plugin compilation
cargo check

# Build Rust plugin
cargo build

# Build TypeScript API
pnpm run build

# Run example app
cd examples/liquid-glass-app && pnpm install && pnpm tauri dev
```

## Project Overview

**tauri-liquid-glass** is a Tauri v2 plugin that provides macOS Liquid Glass effects for Tauri applications using native Objective-C APIs.

- **macOS 26+**: Uses private `NSGlassEffectView` API for the native Liquid Glass effect
- **macOS 10.10-25**: Falls back to `NSVisualEffectView` with overlay-based tint
- **Other platforms**: Safe no-ops

## Architecture

### Directory Structure

```
tauri-liquid-glass/
├── src/                      # Rust plugin source
│   ├── lib.rs               # Plugin entry point, LiquidGlassExt trait, registers commands
│   ├── desktop.rs           # LiquidGlass<R> struct with Rust API methods
│   ├── commands.rs          # 2 Tauri commands (internal, called via invoke)
│   ├── models.rs            # LiquidGlassConfig and GlassMaterialVariant (24 variants)
│   ├── error.rs             # Plugin error types with serde serialization
│   └── glass_effect/        # macOS native implementation
│       ├── mod.rs           # Internal API: is_glass_supported(), set_liquid_glass_effect()
│       ├── backend.rs       # GlassBackend trait + NativeGlassBackend + VisualEffectBackend
│       ├── operations.rs    # create/update/remove glass effect operations
│       ├── registry.rs      # GlassViewRegistry for tracking views per window
│       └── utils.rs         # run_on_main_sync(), color_from_hex(), glass_class_available()
├── guest-js/                # TypeScript API
│   ├── index.ts             # Exports isGlassSupported(), setLiquidGlassEffect()
│   └── types.ts             # LiquidGlassConfig interface, GlassMaterialVariant const
├── permissions/             # Tauri permission definitions
│   ├── default.toml         # Default permission set
│   └── autogenerated/       # Auto-generated permission files
├── examples/
│   └── liquid-glass-app/    # Complete example Tauri app
└── dist/                    # Built TypeScript output
```

### Core Concepts

#### 1. Simplified API Design

The plugin uses a **single command API** (`set_liquid_glass_effect`) that handles:
- Creating new glass effects
- Updating existing glass effects  
- Removing glass effects (when `enabled: false`)

The plugin automatically manages state via `GlassViewRegistry` which tracks glass views per window label.

#### 2. Backend Pattern (Strategy Pattern)

The `GlassBackend` trait abstracts differences between:
- **NativeGlassBackend**: Uses `NSGlassEffectView` (macOS 26+)
- **VisualEffectBackend**: Uses `NSVisualEffectView` (fallback)

Key differences:
- `NSGlassEffectView` has native `setTintColor:` support
- `NSVisualEffectView` requires an overlay subview for tint colors
- Only `NSGlassEffectView` supports material variants

#### 3. Thread Safety

All native NSView operations must run on the main thread. The plugin uses:
- `run_on_main_sync()` - Dispatches closures to main thread via `dispatch::Queue::main()`
- `ViewHandle(usize)` - Stores raw pointer addresses instead of `id` types for cross-thread safety

#### 4. Objective-C Bridging

Uses `objc` + `cocoa` crates (not the newer `objc2` ecosystem). These are technically deprecated but:
- Remain fully functional for this use case
- Avoid complexity of `objc2`'s `MainThreadMarker` and strict `Send`/`Sync` requirements
- The `#![allow(deprecated)]` attribute suppresses related warnings

### Public API

The plugin exposes both TypeScript and Rust APIs:

**TypeScript** (`guest-js/index.ts`):
- `isGlassSupported()` - Check if NSGlassEffectView is available
- `setLiquidGlassEffect(config)` - Apply, update, or remove glass effect (auto-detects current window)

**Rust** (`src/lib.rs` + `src/desktop.rs`):
- `LiquidGlassExt` trait - Extension trait for `Manager` types (AppHandle, App, WebviewWindow)
- `app.liquid_glass().is_supported()` - Check if NSGlassEffectView is available
- `app.liquid_glass().set_effect(&window, config)` - Apply, update, or remove glass effect

**Tauri Commands** (internal, called via invoke):
- `plugin:liquid-glass|is_glass_supported`
- `plugin:liquid-glass|set_liquid_glass_effect`

### Permission Names

- `allow-is-glass-supported`
- `allow-set-liquid-glass-effect`

## Key Technical Details

### LiquidGlassConfig

```rust
pub struct LiquidGlassConfig {
    pub enabled: bool,           // Default: true
    pub corner_radius: f64,      // Default: 0.0
    pub tint_color: Option<String>,  // Format: #RRGGBB or #RRGGBBAA
    pub variant: GlassMaterialVariant,  // Default: Regular (0)
}
```

### GlassMaterialVariant

24 variants (0-23): Regular, Clear, Dock, AppIcons, Widgets, Text, Avplayer, Facetime, ControlCenter, NotificationCenter, Monogram, Bubbles, Identity, FocusBorder, FocusPlatter, Keyboard, Sidebar, AbuttedSidebar, Inspector, Control, Loupe, Slider, Camera, CartouchePopover

### Error Types

- `UnsupportedPlatform` - Not macOS
- `UnsupportedMacOSVersion` - macOS < 26 (for glass-specific features)
- `WindowNotFound(String)` - Window label not found
- `ViewCreationFailed` - NSGlassEffectView/NSVisualEffectView alloc failed
- `RegistryLockFailed` - Mutex poison
- `InvalidColorFormat(String)` - Bad hex color
- `Tauri(Error)` - Wrapped Tauri error

## Common Development Tasks

### Adding a New Glass Configuration Option

1. Add field to `LiquidGlassConfig` in `src/models.rs`
2. Add corresponding field to `LiquidGlassConfig` interface in `guest-js/types.ts`
3. Apply the option in `apply_glass_config()` in `src/glass_effect/operations.rs`
4. If backend-specific handling needed, add method to `GlassBackend` trait in `backend.rs`

### Adding a New Command

1. Create function in `src/commands.rs` with `#[command]` attribute
2. Register in `invoke_handler` in `src/lib.rs`
3. Add permission in `permissions/default.toml`
4. Add TypeScript wrapper in `guest-js/index.ts`
5. Run `cargo build` to regenerate permission files

### Testing Changes

```bash
# Test Rust compilation
cargo check
cargo build

# Test TypeScript compilation
pnpm run build

# Test in example app
cd examples/liquid-glass-app
pnpm install
pnpm tauri dev
```

## Dependencies

### Rust (macOS-specific)

- `cocoa` - NSView, NSWindow, NSVisualEffectView bindings
- `objc` - Objective-C runtime and message sending
- `dispatch` - GCD queue for main thread dispatch

### Rust (Cross-platform)

- `tauri` / `tauri-plugin` - Plugin framework
- `serde` / `serde_json` - Serialization for JS interop
- `serde_repr` - Integer enum serialization
- `thiserror` - Error derive macro
- `log` - Logging facade

### TypeScript

- `@tauri-apps/api` - Tauri API for invoke and window

## Repository Notes

- **Package name (Rust)**: `tauri-liquid-glass`
- **Package name (npm)**: `tauri-liquid-glass` (same)
- **Plugin identifier**: `liquid-glass`
- **Minimum Rust version**: 1.77
- **Tauri version**: 2.0
